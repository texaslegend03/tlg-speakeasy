<!DOCTYPE html>
<html>
<head>
    <title>Moonshine Minigame</title>
    <style>
        #minigame {
            display: none;
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #temperature, #progress {
            font-size: 18px;
            margin: 10px 0;
        }
        #stirButton, #mashButton {
            display: none;
            position: absolute;
            background: #ffcc00;
            color: black;
            padding: 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        #stirButton:hover, #mashButton:hover {
            background: #ffee00;
        }
    </style>
</head>
<body>
    <div id="minigame">
        <div id="temperature">Temperature: 150°F</div>
        <div id="progress">Progress: 0%</div>
    </div>
    <button id="stirButton" onclick="stir()">Stir</button>
    <button id="mashButton" onclick="addMash()">Add Mash</button>

    <script>
    let timeoutIds = {};
    let speakeasyName = ""; // Store the speakeasy name passed from Lua

    window.addEventListener('message', function(event) {
        const data = event.data;
        if (data.action === "start") {
            document.getElementById('minigame').style.display = 'block';
            document.getElementById('temperature').innerText = "Temperature: 150°F";
            document.getElementById('progress').innerText = "Progress: 0%";
            speakeasyName = data.speakeasyName || "Valentine Speakeasy"; // Set speakeasy name
        } else if (data.action === "update") {
            document.getElementById('temperature').innerText = "Temperature: " + data.temperature + "°F";
            document.getElementById('progress').innerText = "Progress: " + data.progress + "%";
        } else if (data.action === "end") {
            document.getElementById('minigame').style.display = 'none';
            document.getElementById('stirButton').style.display = 'none';
            document.getElementById('mashButton').style.display = 'none';
            clearTimeouts();
            if (data.success) { // Check if the end action indicates success
                fetch(`https://${GetParentResourceName()}/triggerEvent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        event: 'speakeasy:brewMinigameSuccess',
                        data: { speakeasyName: speakeasyName }
                    })
                }).then(resp => resp.text()).then(text => console.log("Success event triggered: " + text));
            }
        } else if (data.action === "hide") {
            document.getElementById('minigame').style.display = 'none';
            document.getElementById('stirButton').style.display = 'none';
            document.getElementById('mashButton').style.display = 'none';
            clearTimeouts();
        } else if (data.action === "show_stir_button") {
            showButton('stirButton', data.x, data.y, data.duration);
        } else if (data.action === "show_mash_button") {
            showButton('mashButton', data.x, data.y, data.duration);
        } else if (data.action === "hide_stir_button") {
            document.getElementById('stirButton').style.display = 'none';
            clearTimeout(timeoutIds['stirButton']);
        } else if (data.action === "hide_mash_button") {
            document.getElementById('mashButton').style.display = 'none';
            clearTimeout(timeoutIds['mashButton']);
        }
    });

    function showButton(buttonId, x, y, duration) {
        const button = document.getElementById(buttonId);
        button.style.left = x + '%';
        button.style.top = y + '%';
        button.style.display = 'block';
        clearTimeout(timeoutIds[buttonId]);
        timeoutIds[buttonId] = setTimeout(() => {
            button.style.display = 'none';
        }, duration);
    }

    function clearTimeouts() {
        for (let id in timeoutIds) {
            clearTimeout(timeoutIds[id]);
        }
        timeoutIds = {};
    }

    function stir() {
        fetch(`https://${GetParentResourceName()}/stir`, {
            method: 'POST',
            body: JSON.stringify({})
        }).then(resp => resp.text()).then(text => console.log(text));
    }

    function addMash() {
        fetch(`https://${GetParentResourceName()}/add_mash`, {
            method: 'POST',
            body: JSON.stringify({})
        }).then(resp => resp.text()).then(text => console.log(text));
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 't' && document.getElementById('minigame').style.display === 'block') {
            fetch(`https://${GetParentResourceName()}/raise_temp`, {
                method: 'POST',
                body: JSON.stringify({})
            }).then(resp => resp.text()).then(text => console.log(text));
        }
    });
</script>
</body>
</html>